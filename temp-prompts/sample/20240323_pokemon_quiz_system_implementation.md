# ポケモンクイズシステム実装タスク（2024/03/23版）

> **注意**: このタスクファイルは、より効率的な開発プロセスを実現するために、以前のバージョン（20240322）を置き換えるものです。小さなサイクルを回しながら、テストファーストで開発を進めていきます。

## プロジェクトの背景
### システムの目的
- ユーザー登録不要の気軽な参加型クイズシステム
- ポケモンの知識を楽しく共有・確認できる場の提供
- リアルタイムな進行状況の共有による一体感の創出

### 技術スタック
- Next.js
- Prisma (MySQL)
- Zod
- Docker

## 実装アウトライン

### 1. 最小限の機能で実現できるユーザーフロー
```
a. クイズルームの作成
   - ルームコードの生成
   - 世代の選択
   → 参加用URLの生成

b. クイズルームへの参加
   - URLからのアクセス
   - ニックネームの登録
   → クイズ画面の表示

c. クイズの回答
   - ポケモン名の入力
   - 正誤判定
   → 結果の表示
```

### 2. 段階的な拡張ポイント
```
a. ルーム作成の拡張
   - 詳細な設定オプション
   - カスタムルールの設定
   - 制限時間の設定

b. 参加者管理の拡張
   - セッション管理
   - 参加者一覧表示
   - 進捗状況の表示

c. クイズ機能の拡張
   - リアルタイム更新
   - ヒント機能
   - 回答履歴表示
```

### 3. 技術的な実現方法
```
a. データの流れ
   - ルーム情報の永続化（MySQL）
   - セッション情報の管理（Cookie）
   - 回答データの蓄積（MySQL）

b. UI/UX
   - レスポンシブデザイン
   - フォーム入力の最適化
   - エラーハンドリング

c. パフォーマンス
   - データベースインデックス
   - キャッシュ戦略
   - ポーリング最適化
```

## フェーズ分割

### フェーズ1: 最小限のルーム作成と参加（MVP）
- ルーム作成（世代選択のみ）
- 参加者登録（ニックネームのみ）
- 最小限のUI
目的: 基本的なフローの確立と技術検証

### フェーズ2: 基本的なクイズ機能
- ポケモン名による回答
- 基本的な正誤判定
- 自分の回答履歴の表示
目的: コアゲーム機能の実装

### フェーズ3: セッション管理
- セッション管理の実装
- 同一セッションでの複数ルーム参加
目的: 継続的なプレイ体験の実現

### フェーズ4（オプション）: 拡張機能とUX改善

必要に応じて以下のような改善を検討する：

1. UX改善
   - ローディング表示の改善
   - エラーメッセージの改善
   - アニメーションの追加

2. 機能拡張
   - 新しい要件に応じて検討

※ フェーズ1-3の運用状況を見て、必要性を判断する

## 現在の状態
- [x] 基盤の整備（データベース、Prisma設定）は完了
- [x] 実装アウトラインの合意完了
- [x] フェーズ分割と優先順位付けの合意完了
- [ ] フェーズ1のタスク分解作成中

## フェーズ1の詳細タスク分解

### フェーズ1-A: ルーム作成

#### room モジュール
1. CreateRoomCommand のテスト作成
2. CreateRoomCommand の実装
   - ルーム作成ロジック
   - ルームコード生成ロジック
3. GetRoomByCodeQuery のテスト作成
4. GetRoomByCodeQuery の実装
   - ルーム取得ロジック

#### API層
1. POST /api/rooms のテスト作成
2. エンドポイントの実装
   - リクエストバリデーション
   - レスポンス形式の定義

#### フロントエンド層
1. ルーム作成ページのコンポーネントテスト作成
2. ページコンポーネントの実装
   - 世代選択フォーム
   - 作成ボタン
   - 参加用URL表示

#### E2E
1. ルーム作成フローのE2Eテスト作成
2. 必要に応じた調整・修正

### フェーズ1-B: 参加者作成

#### participant モジュール
1. CreateParticipantCommand のテスト作成
2. CreateParticipantCommand の実装
   - 参加者作成ロジック
3. GetParticipantQuery のテスト作成
4. GetParticipantQuery の実装
   - 参加者情報取得ロジック

#### API層
1. POST /api/participants のテスト作成
2. エンドポイントの実装
   - ニックネームバリデーション
   - レスポンス形式の定義

#### フロントエンド層
1. 参加者作成フォームのコンポーネントテスト作成
2. フォームコンポーネントの実装
   - ニックネーム入力
   - 作成ボタン

#### E2E
1. 参加者作成フローのE2Eテスト作成
2. 必要に応じた調整・修正

### フェーズ1-C: ルーム参加

#### room モジュール
1. JoinRoomCommand のテスト作成
2. JoinRoomCommand の実装
   - ルーム参加ロジック
3. GetRoomParticipantsQuery のテスト作成
4. GetRoomParticipantsQuery の実装
   - ルーム参加者取得ロジック

#### API層
1. POST /api/rooms/{roomCode}/participants/{participantId} のテスト作成
2. エンドポイントの実装
   - リクエストバリデーション
   - レスポンス形式の定義

#### フロントエンド層
1. ルーム参加処理のコンポーネントテスト作成
2. 参加処理の実装
   - 参加確認UI
   - 完了表示

#### E2E
1. ルーム参加フローのE2Eテスト作成
2. 必要に応じた調整・修正

## フェーズ2の詳細タスク分解

### フェーズ2-A: 回答状況の表示

#### room モジュール
1. GetRoomAnswersQuery のテスト作成
2. GetRoomAnswersQuery の実装
   - ルームの回答状況取得（正解済み/未回答）
   - 参加者の進捗情報取得
   - 正解数/総数の集計

#### API層
1. GET /api/rooms/{roomCode}/answers のテスト作成
2. エンドポイントの実装
   - 回答状況と進捗情報のレスポンス

#### フロントエンド層
1. 回答状況表示コンポーネントのテスト作成
2. コンポーネントの実装
   - 回答済み/未回答の一覧表示
   - 正解数/総数の表示
   - 参加者の進捗表示
   - リアルタイム更新の仕組み

### フェーズ2-B: 回答処理

#### answer モジュール
1. SubmitAnswerCommand のテスト作成
2. SubmitAnswerCommand の実装
   - ポケモン名の検証
   - 正誤判定と回答状況の更新
3. GetAnswerHistoryQuery のテスト作成
4. GetAnswerHistoryQuery の実装
   - 自分の回答履歴取得

#### API層
1. POST /api/rooms/{roomCode}/answers のテスト作成
2. エンドポイントの実装
   - 回答提出
   - 判定結果のレスポンス

#### フロントエンド層
1. 回答フォームのテスト作成
2. フォームの実装
   - 回答入力
   - 送信処理
   - 結果表示（正解/不正解）

## フェーズ3の詳細タスク分解

### フェーズ3-A: セッション管理基盤

#### session モジュール
1. CreateSessionCommand のテスト作成
2. CreateSessionCommand の実装
   - セッションID生成
   - セッション情報の保存
3. GetSessionQuery のテスト作成
4. GetSessionQuery の実装
   - セッション情報の取得
   - 有効期限の確認と管理

#### API層
1. セッション管理ミドルウェアのテスト作成
2. ミドルウェアの実装
   - Cookieからのセッション取得
   - 新規セッション作成
   - セッション有効性確認

#### フロントエンド層
1. セッション管理フックのテスト作成
2. フックの実装
   - セッション状態の管理
   - セッション切れ時の再作成

### フェーズ3-B: セッションベースの状態管理

#### room モジュール
1. JoinRoomCommand 拡張のテスト作成
2. JoinRoomCommand の拡張実装
   - セッションへのルーム参加情報の記録
   - 重複参加のチェック
3. GetSessionRoomsQuery のテスト作成
4. GetSessionRoomsQuery の実装
   - 参加中ルーム一覧取得

#### API層
1. GET /api/session/rooms のテスト作成
2. エンドポイントの実装
   - 参加中ルーム一覧レスポンス
3. 既存APIのセッション対応
   - ルーム作成/参加APIの更新

#### フロントエンド層
1. 参加中ルーム一覧コンポーネントのテスト作成
2. コンポーネントの実装
   - ルーム一覧表示
   - ルーム切り替え機能
3. 既存コンポーネントの更新
   - セッションベースの状態管理対応

#### E2E
1. セッション管理フローのE2Eテスト作成
2. 複数ルーム参加フローのE2Eテスト作成
3. 必要に応じた調整・修正

## 次のステップ
1. フェーズ1の実装開始